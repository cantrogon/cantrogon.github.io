<div id="main">
	<svg id="main-svg"></svg>
</div>

<style>

body {margin: 0;}

polygon {
	fill: white; 
	stroke: black; 
	transition: .1s;
}

#main {
	width: 100%;
	height: 100vh;
	position: relative;
	border: 10px solid black;
	box-sizing: border-box;
	font: 60px Verdana, sans-serif;
}

#main-svg {
	width: 100%;
	height: 100%;
	/*transform: rotateX(180deg) rotateZ(90deg);*/
	transform: rotateX(180deg);
}

</style>

<script>

function getHexPoints(x,y,l) {
	var p = l * Math.sqrt(3) / 3,
		q = l * 2 / Math.sqrt(3);
	return [[x,y+q],[x+l,y+p],[x+l,y-p],[x,y-q],[x-l,y-p],[x-l,y+p]];
}

function getHexPositions(x,y,w,h,l) {
	var arr = [];
	for (var i = 0; i < h; i++) {
		arr[i] = [];
		for (var j = 0; j < w; j++) {
			var dx = l * 2 * j,
				dy = l * 3 / Math.sqrt(3) * i;
			if (i % 2) dx += l;
			arr[i][j] = [x+dx,y+dy];
		}
	}
	return arr;
}

var hexes = [], touches = [];
var context = new AudioContext()

var mouseDown = false;
document.body.addEventListener("mousedown", e => mouseDown = true);
document.body.addEventListener("mouseup", e => mouseDown = false);

// drawHex(0,0,12,6,50);
drawHex(0,0,14,10,70);

function drawHex(x,y,w,h,l) {
	var svg = document.getElementById('main-svg');
	var pos = getHexPositions(x,y,w,h,l);
	pos.forEach((p,i) => {
		p.forEach((p,j) => {
			var points = getHexPoints(p[0],p[1],l);
			var hexPoints = points.join(' ');
			var hex = document.createElementNS('http://www.w3.org/2000/svg','polygon');
			hex.setAttribute('points',hexPoints);
			svg.appendChild(hex);

			// var stepx = 2/12, stepy = 5/12;
			var stepx = 7/12, stepy = 3/12;
			// var stepx = 2/12, stepy = 1/12;
			// var stepx = 7/12, stepy = 12/12;
			// var stepx = 3/12, stepy = 1/12;
			// var stepx = 3/12, stepy = 2/12;
			// var stepx = 3/12, stepy = 2/12;

			var mod = 6.5;
			var val = (j - Math.floor(i/2)) * stepx + i * stepy + mod;

			var o = context.createOscillator()
			var g = context.createGain()
			o.type = "sine"
			o.connect(g)
			o.frequency.value = Math.pow(2,val)
			g.connect(context.destination)

			if (!hexes[i]) hexes[i] = [];
			hexes[i].push({
				hex: hex,
				o: o,
				g: g,
				oStarted: false,
				playing: false
			});
			hex.setAttribute('pos', i + ' ' + j);

			hex.addEventListener("mousedown", e => onDown(i,j));
			hex.addEventListener("mouseup", e => onUp(i,j));
			hex.addEventListener("mouseover", e => {if (mouseDown) onDown(i,j)});
			hex.addEventListener("mouseout", e => onUp(i,j));
			hex.addEventListener("touchstart", e => {e.preventDefault();});
			hex.addEventListener("touchend", e => {e.preventDefault();});
			hex.addEventListener("touchmove", e => {e.preventDefault();});
			hex.addEventListener("touchcancel", e => {e.preventDefault(); e.stopPropagation();});
		})
	})

	svg.addEventListener("touchstart", e => {
		for (var i = 0; i < e.touches.length; i++) {
			var touch = e.touches[i], n = touch.identifier;
			var elm = document.elementFromPoint(touch.clientX,touch.clientY);
			if (elm !== null && elm.tagName === "polygon") {
				var strPos = elm.getAttribute("pos");
				var pos = strPos.split(" ");
				onDown(pos[0],pos[1]);
				touches[n] = strPos;
			}
			else 
				touches[n] = null;
		}
	})

	svg.addEventListener("touchend", e => {
		var touch = e.changedTouches[0], n = touch.identifier;
		var elm = document.elementFromPoint(touch.clientX,touch.clientY);
		if (elm !== null && elm.tagName === "polygon") {
			var otherTouches = touches.slice();
			otherTouches.splice(n,1);
			if (touches[n] !== null && !otherTouches.includes(touches[n])) {
				var pos = touches[n].split(" ");
				onUp(pos[0],pos[1]);
			}
			touches[n] = null;
		}
	})

	svg.addEventListener("touchmove", e => {
		for (var i = 0; i < e.changedTouches.length; i++) {
			var touch = e.changedTouches[i], n = touch.identifier;
			var elm = document.elementFromPoint(touch.clientX,touch.clientY);
			if (elm !== null && elm.tagName === "polygon") {
				var pos = elm.getAttribute("pos");
				if (pos !== touches[n]) {
					var otherTouches = touches.slice();
					otherTouches.splice(n,1);
					if (touches[n] !== null && !otherTouches.includes(touches[n])) {
						var pos1 = touches[n].split(" ");
						onUp(pos1[0],pos1[1]);
					}
					var pos2 = pos.split(" ");
					onDown(pos2[0],pos2[1]);
					touches[n] = pos;
				}
			} else if (touches[n] !== null) {
				var pos1 = touches[n].split(" ");
				onUp(pos1[0],pos1[1]);
				touches[n] = null;
			}
		}
	})

}


function onDown(i,j) {
	var hex = hexes[i][j];

	hex.hex.style.fill = "green";
	hex.hex.style.transition = "none";
	
	hex.playing = true;

	if (!hex.oStarted){
		hex.oStarted = true
   		hex.g.gain.value = 0;
		hex.o.start()
	}
   	// hex.g.gain.setValueAtTime(0.00001, context.currentTime); 
	// hex.g.gain.exponentialRampToValueAtTime(1, context.currentTime + 0.01);
	hex.g.gain.setTargetAtTime(0.25, context.currentTime, 0.015);
}

function onUp(i,j) {
	var hex = hexes[i][j];
	hex.hex.style.fill = "white";
	hex.hex.style.transition = "fill ease-out .7s";
	// manageFill(i,j);
	hex.playing = false;

    // hex.g.gain.setValueAtTime(hexes[i][j].g.gain.value, context.currentTime); 
	// hex.g.gain.exponentialRampToValueAtTime(0.00001, context.currentTime + 0.04)
	hex.g.gain.setTargetAtTime(0, context.currentTime, 0.015);
}

</script>
